<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Tip Jar with Referrals</title>
    
    <!-- Ethers.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    
    <!-- Microsoft Clarity Tracking -->
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "twdqda1bwf");
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.8em;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-bottom: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .status {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            word-break: break-all;
        }
        
        .status.connected {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        
        .status.error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        
        .tip-amounts {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tip-btn {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 10px;
        }
        
        .tip-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        .referral-link {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            word-break: break-all;
        }
        
        .copy-btn {
            background: #ffc107;
            color: #333;
            margin-top: 10px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .emoji {
            font-size: 48px;
            text-align: center;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="emoji">üí∏</div>
            <h1>Crypto Tip Jar</h1>
            <p class="subtitle">Send tips with ETH ‚Ä¢ Earn 10% referral rewards forever</p>
            
            <div id="status" class="status">
                üëõ Connect your wallet to get started (MetaMask, Rabby, or any Web3 wallet)
            </div>
            
            <button id="connectBtn" onclick="connectWallet()">
                Connect Wallet
            </button>
        </div>
        
        <div class="card" id="tipSection" style="display: none;">
            <h2>üí∞ Send a Tip</h2>
            
            <div class="tip-amounts">
                <button class="tip-btn" onclick="setAmount('0.001')">0.001 ETH</button>
                <button class="tip-btn" onclick="setAmount('0.01')">0.01 ETH</button>
                <button class="tip-btn" onclick="setAmount('0.1')">0.1 ETH</button>
            </div>
            
            <label>Amount (ETH)</label>
            <input type="number" id="tipAmount" placeholder="0.01" step="0.001" min="0.001">
            
            <label>Message (Optional)</label>
            <input type="text" id="tipMessage" placeholder="Thanks for the awesome content!">
            
            <button onclick="sendTip()">Send Tip üöÄ</button>
        </div>
        
        <div class="card" id="referralSection" style="display: none;">
            <h2>üéÅ Your Referral Link</h2>
            <p class="subtitle">Share this link and earn 10% commission on all tips forever!</p>
            
            <div class="referral-link">
                <strong>Your Referral Link:</strong><br>
                <span id="referralLink">-</span>
            </div>
            
            <button class="copy-btn" onclick="copyReferralLink()">üìã Copy Link</button>
            
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-value" id="myTips">0</div>
                    <div class="stat-label">My Tips Sent</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="myEarnings">0 ETH</div>
                    <div class="stat-label">Referral Earnings</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="referralCount">0</div>
                    <div class="stat-label">People Referred</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="totalTips">0 ETH</div>
                    <div class="stat-label">Total Tips (All Users)</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Wait for ethers to load before running anything
        window.addEventListener('load', function() {
            // Check if ethers loaded correctly
            if (typeof ethers === 'undefined') {
                document.getElementById('status').innerHTML = '‚ùå Failed to load ethers.js library. Please refresh the page.';
                document.getElementById('status').className = 'status error';
                return;
            }
            
            console.log('Ethers.js loaded successfully:', ethers.version);
            initializeDApp();
        });
        
        // Contract details
        const CONTRACT_ADDRESS = "0x2df91456375c40eece0717f1a8e5f1489bb219b4";
        
        // Contract ABI (only the functions we need)
        const CONTRACT_ABI = [
            "function tip(string calldata message) external payable",
            "function tipWithReferral(address _referrer, string calldata message) external payable",
            "function setReferrer(address _referrer) public",
            "function getReferralStats(address user) external view returns (address referrer, uint256 totalTipped, uint256 earnedFromReferrals, uint256 peopleReferred)",
            "function totalTips() external view returns (uint256)",
            "function totalReferralsPaid() external view returns (uint256)",
            "function referrers(address) external view returns (address)"
        ];
        
        let provider;
        let signer;
        let contract;
        let userAddress;
        
        function initializeDApp() {
            // Check if already connected on page load
            if (typeof window.ethereum !== 'undefined') {
                window.ethereum.request({ method: 'eth_accounts' })
                    .then(accounts => {
                        if (accounts.length > 0) {
                            connectWallet();
                        }
                    })
                    .catch(err => console.error('Error checking accounts:', err));
            }
        }
        
        // Connect to wallet (works with MetaMask, Rabby, and other Web3 wallets)
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    updateStatus('‚ùå Please install MetaMask or Rabby Wallet to use this dApp', 'error');
                    return;
                }
                
                // Request account access (works with Rabby and MetaMask)
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // Create provider and signer
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                // Check if we're on the right network (Ethereum Mainnet = 1)
                const network = await provider.getNetwork();
                if (network.chainId !== 1) {
                    updateStatus('‚ö†Ô∏è Please switch to Ethereum Mainnet in your wallet', 'error');
                    return;
                }
                
                // Create contract instance
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                
                // Update UI
                updateStatus(`‚úÖ Connected: ${userAddress.substring(0, 6)}...${userAddress.substring(38)}`, 'connected');
                document.getElementById('connectBtn').textContent = 'Connected ‚úì';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('tipSection').style.display = 'block';
                document.getElementById('referralSection').style.display = 'block';
                
                // Load user stats
                await loadStats();
                
                // Check for referral in URL
                const urlParams = new URLSearchParams(window.location.search);
                const ref = urlParams.get('ref');
                if (ref && ethers.utils.isAddress(ref)) {
                    try {
                        const currentRef = await contract.referrers(userAddress);
                        if (currentRef === ethers.constants.AddressZero) {
                            await contract.setReferrer(ref);
                            updateStatus('üéâ Referrer set successfully!', 'connected');
                        }
                    } catch (error) {
                        console.log('Referrer already set or error:', error);
                    }
                }
                
                // Generate referral link
                const baseUrl = window.location.origin + window.location.pathname;
                document.getElementById('referralLink').textContent = `${baseUrl}?ref=${userAddress}`;
                
            } catch (error) {
                console.error(error);
                updateStatus('‚ùå Failed to connect wallet: ' + error.message, 'error');
            }
        }
        
        // Load user statistics
        async function loadStats() {
            try {
                const stats = await contract.getReferralStats(userAddress);
                const totalTips = await contract.totalTips();
                
                document.getElementById('myTips').textContent = stats.totalTipped.toString();
                document.getElementById('myEarnings').textContent = ethers.utils.formatEther(stats.earnedFromReferrals) + ' ETH';
                document.getElementById('referralCount').textContent = stats.peopleReferred.toString();
                document.getElementById('totalTips').textContent = ethers.utils.formatEther(totalTips) + ' ETH';
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        // Set tip amount
        function setAmount(amount) {
            document.getElementById('tipAmount').value = amount;
        }
        
        // Send tip
        async function sendTip() {
            try {
                const amount = document.getElementById('tipAmount').value;
                const message = document.getElementById('tipMessage').value || "";
                
                if (!amount || parseFloat(amount) <= 0) {
                    alert('Please enter a valid tip amount');
                    return;
                }
                
                updateStatus('‚è≥ Sending tip... Please confirm in your wallet', 'status');
                
                const value = ethers.utils.parseEther(amount);
                
                // Send tip
                const tx = await contract.tip(message, { value: value });
                
                updateStatus('‚è≥ Transaction submitted! Waiting for confirmation...', 'status');
                
                await tx.wait();
                
                updateStatus('‚úÖ Tip sent successfully! üéâ', 'connected');
                
                // Clear inputs
                document.getElementById('tipAmount').value = '';
                document.getElementById('tipMessage').value = '';
                
                // Reload stats
                await loadStats();
                
            } catch (error) {
                console.error(error);
                if (error.code === 4001) {
                    updateStatus('‚ùå Transaction rejected by user', 'error');
                } else {
                    updateStatus('‚ùå Transaction failed: ' + error.message, 'error');
                }
            }
        }
        
        // Copy referral link
        function copyReferralLink() {
            const link = document.getElementById('referralLink').textContent;
            navigator.clipboard.writeText(link)
                .then(() => {
                    alert('‚úÖ Referral link copied to clipboard!');
                })
                .catch(err => {
                    console.error('Failed to copy:', err);
                    alert('Failed to copy link. Please copy manually.');
                });
        }
        
        // Update status message
        function updateStatus(message, type = '') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = 'status ' + type;
        }
        
        // Listen for account changes (works with both MetaMask and Rabby)
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length > 0) {
                    window.location.reload();
                } else {
                    updateStatus('üëõ Please connect your wallet', 'error');
                }
            });
            
            window.ethereum.on('chainChanged', function (chainId) {
                window.location.reload();
            });
        }
    </script>
</body>
</html>
